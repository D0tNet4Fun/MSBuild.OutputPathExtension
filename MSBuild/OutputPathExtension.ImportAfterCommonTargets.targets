<!--
***********************************************************************************************
OutputPathExtension.ImportAfterCommonTargets.props

WARNING:  DO NOT MODIFY this file unless you are knowledgeable about MSBuild and have
          created a backup copy.  Incorrect changes to this file will make it
          impossible to load or build your projects from the command-line or the IDE.

***********************************************************************************************
-->

<!--EXTERNAL_PROPERTIES: UseLinksInOutputPath;_RootOutputPathExists-->
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- enable CreateHardLinks* CreateSymbolicLinks* built-in properties -->
  <!--use hard links when copying from obj to bin and use symbolic links otherwise -->
  <PropertyGroup Condition="'$(UseLinksInOutputPath)' == 'true' AND $(_RootOutputPathExists)">
    <CreateSymbolicLinksForCopyAdditionalFilesIfPossible>true</CreateSymbolicLinksForCopyAdditionalFilesIfPossible>
    <CreateSymbolicLinksForCopyLocalIfPossible>true</CreateSymbolicLinksForCopyLocalIfPossible>
    <CreateHardLinksForCopyFilesToOutputDirectoryIfPossible>true</CreateHardLinksForCopyFilesToOutputDirectoryIfPossible>
  </PropertyGroup>

  <PropertyGroup Condition="'$(UseLinksInOutputPath)' == 'true' AND $(_RootOutputPathExists)">
    <PrepareForRunDependsOn>_IgnoreBuildingInsideVisualStudio;$(PrepareForRunDependsOn);_RestoreBuildingInsideVisualStudio</PrepareForRunDependsOn>
  </PropertyGroup>

  <!--
  ============================================================
                                      _LinkOutputDirectories

  Creates symbolic links for obj\ and bin\ to target corresponding directories relative to $(ProjectRootOutputPath).
  This happens either before restoring NuGet packages (if the project uses PackageReferences) or before the build runs.
  ============================================================
  -->
  <Target Name="_LinkOutputDirectories"
          Condition="$(UseLinksInOutputPath) == 'true'"
          BeforeTargets="PrepareForBuild"
          AfterTargets="_GenerateProjectRestoreGraph">
    <ItemGroup>
      <LinkOutputDirectory Include="$(IntermediateOutputPath)" Condition="!$([System.IO.Path]::IsPathRooted('$(IntermediateOutputPath)'))">
        <RootPath>$(IntermediateOutputPath.Split('\')[0])\</RootPath>
        <FinalPath>$(ProjectRootOutputPath)%(RootPath)</FinalPath>
      </LinkOutputDirectory>
      <LinkOutputDirectory Include="$(OutDir)" Condition="!$([System.IO.Path]::IsPathRooted('$(OutDir)'))">
        <RootPath>$(OutDir.Split('\')[0])\</RootPath>
        <FinalPath>$(ProjectRootOutputPath)%(RootPath)</FinalPath>
      </LinkOutputDirectory>
    </ItemGroup>

    <!-- delete the root paths if they are not symlinks -->
    <Message Condition="Exists('%(LinkOutputDirectory.RootPath)') AND $([MSBuild]::BitwiseAnd(1024, $([System.IO.File]::GetAttributes('%(LinkOutputDirectory.RootPath)')))) == 0"
              Importance="normal" Text='Converting directory "%(LinkOutputDirectory.RootPath)" to a symbolic link targeting "%(LinkOutputDirectory.FinalPath)"' />
    <RemoveDir Condition="Exists('%(LinkOutputDirectory.RootPath)') AND $([MSBuild]::BitwiseAnd(1024, $([System.IO.File]::GetAttributes('%(LinkOutputDirectory.RootPath)')))) == 0"
                Directories="%(LinkOutputDirectory.RootPath)" />
    <!--create the final path directories that will be used as targets for the project relative output directories (obj\ and bin\) -->
    <MakeDir Directories="%(LinkOutputDirectory.FinalPath)" />
    <Exec Command='mklink /D "%(LinkOutputDirectory.RootPath)" "%(LinkOutputDirectory.FinalPath)" >NUL'
          Condition="!Exists('%(LinkOutputDirectory.RootPath)')"
          ContinueOnError="true">
      <Output TaskParameter="ExitCode" PropertyName="MklinkExitCode" />
    </Exec>
    <Warning Text="Could not create a symbolic link for directory %(LinkOutputDirectory.RootPath). Make sure the process runs elevated."
             Condition="$(MklinkExitCode) != '' AND '$(MSBuildLastTaskResult)' == 'false'" />
    <Message Importance="normal" Text='Symbolic link created from "%(LinkOutputDirectory.RootPath)" to "%(LinkOutputDirectory.FinalPath)"'
             Condition="$(MklinkExitCode) != '' AND '$(MSBuildLastTaskResult)' == 'true'" />
  </Target>

  <!--
  ============================================================
                                      _IgnoreBuildingInsideVisualStudio

  Disable BuildingInsideVisualStudio to allow using hard/symbolic links when copying files to output folder. This overrides MSBuild's behavior which disallows this for some reason.
  ============================================================
  -->
  <Target Name="_IgnoreBuildingInsideVisualStudio"
          Condition="'$(BuildingInsideVisualStudio)' == 'true'">
    <PropertyGroup>
      <_BuildingInsideVisualStudio>$(BuildingInsideVisualStudio)</_BuildingInsideVisualStudio>
      <BuildingInsideVisualStudio>false</BuildingInsideVisualStudio>
    </PropertyGroup>
  </Target>

  <!--
  ============================================================
                                      _RestoreBuildingInsideVisualStudio

  Restore the previous value of BuildingInsideVisualStudio.
  ============================================================
  -->
  <Target Name="_RestoreBuildingInsideVisualStudio"
          Condition="'$(_BuildingInsideVisualStudio)' == 'true'">
    <PropertyGroup>
      <BuildingInsideVisualStudio>$(_BuildingInsideVisualStudio)</BuildingInsideVisualStudio>
      <_BuildingInsideVisualStudio></_BuildingInsideVisualStudio>
    </PropertyGroup>
  </Target>

</Project>